@model NibsMVC.Models.Payment

@{
    ViewBag.Title = "Receipt";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using NibsMVC.EDMX;
<div class="page-content">
    <div class="row">
        <p style="color:red">@TempData["Perror"]</p>
        <div class="col-md-12">
            <div class="portlet box blue">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fa fa-gift"></i>Create Receipt
                    </div>
                </div>
                <div class="portlet-body form">
                    <!-- BEGIN FORM-->
                    @using (Html.BeginForm("PaymentToBank", "Finance", FormMethod.Post, new { @id = "form_sample_6", @class = "form-horizontal" }))
                    {

                        @Html.AntiForgeryToken()
                        @Html.ValidationSummary(true)
                        @Html.HiddenFor(model => model.VoucherEntryId)
                        <input type="hidden" name="itemsdata" id="itemsdata" value="" />
                        <div class="form-body">
                            <div class="alert alert-danger display-hide">
                                <button class="close" data-close="alert"></button>
                                You have some form errors. Please check below.
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="col-md-6">Voucher No</label>
                                    <div class="col-md-6">
                                        @Html.TextBoxFor(model => model.VoucherNo, new { @class = "form-control", @id = "vouch" })
                                        @Html.ValidationMessageFor(model => model.VoucherNo)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-md-4">Voucher Date</label>
                                    <div class="col-md-6">
                                        @Html.TextBoxFor(model => model.Date, new { @Value = " ", id = "datepicker", @class = "form-control" })
                                        @Html.ValidationMessageFor(model => model.Date)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="col-md-5">Record No</label>
                                    <div class="col-md-5">
                                        @Html.TextBoxFor(model => model.RecordNo, new { @class = "form-control", @readonly = "readonly" })

                                    </div>
                                </div>
                            </div>

                            <div class="col-md-1">
                                @{ NIBSEntities db1 = new NIBSEntities();
                                    int ptx = 1;
                                    <a class="btn btn-success" data-toggle="modal" href="#@ptx">
                                        Bill Details
                                    </a>
                                    <div class="modal fade" id="@ptx" tabindex="-1" role="basic" aria-hidden="true">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                                            <h4 class="modal-title">Item Details</h4>
                                        </div>
                                        <div class="modal-body">
                                            <table class="table table-bordered" id="sample_13">
                                                <thead>
                                                    <tr>
                                                        <th>Select</th>
                                                        <th>Invoice</th>
                                                        <th>Invoice Date</th>
                                                        <th>Vendor</th>
                                                        <th>Amount</th>
                                                        <th>GST</th>
                                                        <th>Total Amount</th>
                                                        <th>Balance</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @{
                                                        NIBSEntities db = new NIBSEntities();

                                                        var Itemdetails = (from q in db.tblPurchaseMasters select q).ToList();

                                                        foreach (var i in Itemdetails)
                                                        {
                                                            decimal Returned = (from q in db.Voucher_Entry_Debit
                                                                                join p in db.Voucher_Entry_Credit
                                               on new { q.voucher_no, q.record_no } equals new { p.voucher_no, p.record_no }
                                                                                join r in db.tblLedgerMasters on q.voucher_ledger_accout_id equals r.LedgerMasterId
                                                                                where (r.VendorId == i.tblVendor.VendorId)
                                                                                select (decimal?)q.voucher_dbt_amount - p.voucher_cr_amount).Sum() ?? 0;
                                                            <tr>
                                                                <td><input name="checkGRN" type="checkbox" class="check" value="@i.InvoiceNo" /></td>
                                                                <td>@i.InvoiceNo</td>
                                                                <td>@i.InvoiceDate.ToString("dd-MM-yyyy")</td>
                                                                <td>@i.tblVendor.Name</td>
                                                                <td>@i.TotalAmount.ToString("0.00")</td>
                                                                <td>@i.Tax.ToString("0.00")</td>
                                                                <td>@i.NetAmount.ToString("0.00")</td>
                                                                @if (Returned != 0)
                                                                {
                                                                    <td>@Returned</td>
                                                                }
                                                                else
                                                                {
                                                                    <td>@i.NetAmount.ToString("0.00")</td>
                                                                }
                                                                @*<td><a href="@Url.Action("PurchaseReturn", "Purchase", new { purchaseid = i.PurchaseId, purchasdetailId = i.PurchaseDetailId })"><span class="fa fa-repeat"></span></a></td>*@
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" id="selectGRN" class="btn default" data-dismiss="modal">Enter</button>
                                        </div>
                                    </div>
                                }
                            </div>

                            <div class="col-md-12">
                                <div class="portlet">
                                    <div class="portlet-title">
                                        <div class="caption">
                                            <i class="fa fa-gift"></i>By Details
                                        </div>
                                    </div>
                                    <table id="tableRoutingData" class="table table-striped table-bordered">
                                        <thead>
                                            <tr>
                                                <th>By Account</th>
                                                <th>Dr Amount</th>
                                                <th>Cheque No</th>
                                                <th>Cheque Date</th>
                                                <th>Narration</th>
                                                <th>Action</th>

                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr menuid="-1">
                                                <td>
                                                    <select id="cat_0" class="form-control Keys" name="ByAccount"></select>

                                                </td>
                                                <td>
                                                    <input id="Item_0" type="text" class="form-control Keys" name="DrAmount" />

                                                </td>
                                                <td>
                                                    <input id="txtQty_0" type="text" class="form-control Keys" name="ChequeNo" />
                                                </td>
                                                <td>
                                                    <input id="Type_0" type="text" class="form-control Keys" name="ChequeDate" />

                                                </td>
                                                <td>
                                                    <input id="Narration_0" type="text" class="form-control Keys" name="DrNarration" />

                                                </td>
                                                <td>

                                                    <button type="button" id="btnadd" class="btn btn-success btn-sm defaults">
                                                        <span class="fa fa-plus"></span>
                                                    </button>
                                                </td>
                                            </tr>
                                        <tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="portlet">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <i class="fa fa-gift"></i>To Details
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <table id="tableRoutingDataDebit" class="table table-striped table-bordered">
                                        <thead>
                                            <tr>
                                                <th>To Account</th>
                                                <th>Credit Amount</th>
                                                <th>Narration</th>
                                                <th>Action</th>

                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr menuidd="-1">
                                                <td>
                                                    <select id="By_0" class="form-control Keys" name="LedgerAccId"></select>

                                                </td>
                                                <td>
                                                    <input id="Dr_0" type="text" class="form-control Keys" name="CreditAmount" />

                                                </td>
                                                <td>
                                                    <input id="NarrationD_0" type="text" class="form-control" name="CrNarration" />

                                                </td>
                                                <td>

                                                    <button type="button" id="btnaddd" class="btn btn-success btn-sm defaults">
                                                        <span class="fa fa-plus"></span>
                                                    </button>
                                                </td>
                                            </tr>
                                        <tbody>
                                    </table>
                                </div>
                                <div class="row">
                                    <div class="col-md-offset-3 col-md-9">
                                        <button type="submit" id="submitgrn" class="btn green">Submit</button>

                                    </div>
                                </div>
                            </div>
                        </div>
                                                        }

                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {


        $.ajax({
            type: 'POST',
            url: '/Finance/getCategories',

            dataType: 'json',

            //data: { LedgerMasterId: $("#Vendor").val() },


            success: function (items) {

                $("#cat_0").append('<option value="--Select Item--">--Select Category--</option>');
                $.each(items, function (i, item) {
                    $("#cat_0").append('<option value="' + item.Value + '">' + item.Text + '</option>');

                });
            },

            error: function (ex) {
                alert('Failed to retrieve Category and Item.' + ex);
            }
        });
        return false;
    });
    $(document).ready(function () {


        $.ajax({
            type: 'POST',
            url: '/Finance/getByAcc',

            dataType: 'json',

            //data: { LedgerMasterId: $("#Vendor").val() },


            success: function (items) {

                $("#By_0").append('<option value="--Select Item--">--Select Category--</option>');
                $.each(items, function (i, item) {
                    $("#By_0").append('<option value="' + item.Value + '">' + item.Text + '</option>');

                });
            },

            error: function (ex) {
                alert('Failed to retrieve Category and Item.' + ex);
            }
        });
        return false;
    });

    //$(document).on('load', function () {

    //    $.get("/Finance/getCategories", function (data) {

    //        $("#cat_0").append(data);



    //    });
    //$(document).ready(function () {
    //    $.ajax({
    //        url: "/Finance/getCategories",
    //        datatype: "JSON",
    //        type: "POST",
    //        success: function (data) {
    //            $("#cat_0").append(data);
    //        }

    //    });

    //var id = $("vendor").attr('id');
    //var venId = $('#' + id).val();
    //var FormData = { VendorId: venId };
    //$.get('/Purchase/FillDropDownCategories', FormData,
    //        function (data) {

    //            $("#cat_0").append(data);
    //        });


    //});

    //$(document).on('change', 'select[name="RowMaterialId"]', function () {
    //    var id = $(this).attr('id');
    //    var matid = $('#' + id).val();
    //    var FormData = { MaterialId: matid };
    //    var unit = "";
    //    $.get("/StockTransfer/getTransferMaterialUnit", FormData, function (data) {
    //        unit = data;
    //        var row = id.split('_');

    //        $("#Type_" + row[1]).val(unit);
    //    });


    //});


    //});


</script>
<script>
    $(document).ready(function () {

        //    $("#Vendor").change(function () {
        //        $("#cat_0").empty();

        //        $.ajax({
        //            type: 'POST',
        //            url: '/Purchase/FillDropDownCategories',

        //            dataType: 'json',

        //            data: { VendorId: $("#Vendor").val() },


        //            success: function (items) {

        //                $("#cat_0").append('<option value="--Select Item--">--Select Category--</option>');
        //                $.each(items, function (i, item) {
        //                    $("#cat_0").append('<option value="' + item.Value + '">' + item.Text + '</option>');

        //                });
        //            },

        //            error: function (ex) {
        //                alert('Failed to retrieve Category and Item.' + ex);
        //            }
        //        });
        //        return false;
        //    })



        //$(document).on('change', 'select[name="VendorId"]', function () {
        //    var id = $(Vendor).attr('id');
        //    var vendid = $('#' + id).val();
        //    var FormData = { VendorId: vendid };
        //    var unit = "";
        //    $.get('/Purchase/FillDropDownCategories', FormData, function (data) {
        //        unit = data;
        //        var row = id.split('_');

        //        $("#cat_" + row[1]).val(unit);
        //    });


        //});


        var counter = 1;
        $(document).on("click", ".minus", function (e) {
            var id = $(this).attr('id');

            $(this).parent("td").parent("tr").remove();
            counter--;
        });

        @*$("#Vendor").change(function () {
                $("#cycledays").empty();

                $.ajax({
                    type: 'POST',

                    url: '@Url.Action("getPCD")',

                    dataType: 'json',

                    data: { VendorId: $("#Vendor").val() },

                    success: function (items) {

                        $('#cycledays').val(items);

                    },

                    error: function (ex) {
                        alert('Failed to retrieve Cycle');
                    }
                });
                return false;
            })*@

        //$(document).on('change', 'select[name="VendorId"]', function () {

        //    var id = $(Vendor).attr('id');
        //    var venId = $('#' + id).val();
        //    var FormData = { VendorId: venId };
        //    var pcd = "";
        //    $.get("/PurchaseOrder/getPCD", FormData, function (data) {
        //        pcd = data;
        //        $("#txtPCD").val(pcd);
        //    });


        //});

        //$(document).on('change', 'select[name="VendorId"]', function () {
        //    var id = $(this).attr('id');
        //    var venId = $('#' + id).val();
        //    var FormData = { VendorId: venId };
        //    var pcd = "";
        //    $.get("/PurchaseOrder/getPCD", FormData, function (data) {
        //        pcd = data;
        //        $("#txtPCD").val(pcd);
        //    });


        //});

        //$(document).on('change', 'select[name="CreditAmt"]', function () {
        //    var id = $(this).attr('id');
        //    var matid = $('#' + id).val();
        //    var FormData = { MaterialId: matid };
        //    var unit = "";
        //    $.get("/StockTransfer/getTransferMaterialUnit", FormData, function (data) {
        //        unit = data;
        //        var row = id.split('_');

        //        $("#Type_" + row[1]).val(unit);
        //    });


        //});

        //$(document).on('change', 'select[name="LedgerAcc"]', function () {
        //    var id = $(this).attr('id');
        //    var catid = $('#' + id).val();
        //    var FormData = { CategoryId: catid };
        //    var unit = "";

        //    $.get('/Purchase/FillDropDownKeysByCategory', FormData,
        //            function (data) {
        //                var row = id.split('_');
        //                $("#Item_" + row[1]).find('option').remove().end().append(data);
        //            });


        //});

        $('#btnadd').on('click', function () {
            $('#tableRoutingData').append('<tr MenuID="-1" class="trEdit" id="tr_' + counter + '"><td><select id="cat_' + counter + '" name="ByAccount" class="form-control Keys"/></td><td><input id="Item_' + counter + '" type="text" name="DrAmount" class="form-control Keys"/></td><td>' +
                '<input id="txtQty_' + counter + '" type="text" name="ChequeNo" class="form-control input-md"  /></td><td><input id="Type_' + counter + '" type="text" name="ChequeDate" ' +
                 ' class="form-control input-md"/></td><td><input id="Narration_' + counter + '" type="DrNarration" name="DrNarration" ' +
                 ' class="form-control input-md"/></td><td>' +
                  '<button data-val="' + counter + '"' +
                 ' style="margin-top:10px;" type="button" id="btnminus_' + counter + '" ' +
                 'class="minus btn btn-danger btn-sm defaults"><span class="fa fa-minus"></span></button></td></tr>');
            $('#cat_0 option').clone().appendTo('#cat_' + counter);
            $('#Item_0 option').clone().appendTo('#Item_' + counter);
            $('#txtQty_0 option').clone().appendTo('#txtQty_' + counter);
            $('#Type_0 option').clone().appendTo('#Type_' + counter);
            $('#Narration_0 option').clone().appendTo('#Narration_' + counter);
            $("#Type_" + counter).datepicker({ dateFormat: 'dd/mm/yy' });
            counter++;
        });
        $('#btnaddd').on('click', function () {
            $('#tableRoutingDataDebit').append('<tr MenuIDD="-1" class="trEditD" id="tr_' + counter + '"><td><select id="By_' + counter + '" name="LedgerAccId" class="form-control Keys"/></td><td><input id="Dr_' + counter + '" type="text" name="CreditAmount" class="form-control Keys"/></td>' +
                 ' <td><input id="NarrationD_' + counter + '" type="CrNarration" name="CrNarration" ' +
                 ' class="form-control input-md"/></td><td>' +
                  '<button data-val="' + counter + '"' +
                 ' style="margin-top:10px;" type="button" id="btnminus_' + counter + '" ' +
                 'class="minus btn btn-danger btn-sm defaults"><span class="fa fa-minus"></span></button></td></tr>');
            $('#By_0 option').clone().appendTo('#By_' + counter);
            $('#Dr_0 option').clone().appendTo('#Dr_' + counter);
            $('#NarrationD_0 option').clone().appendTo('#NarrationD_' + counter);
            counter++;
        });
    });

    $('#selectGRN').on('click', function () {
        $("tr.trEdit").remove();
        var val = [];
        var FormData = [];

        $(':checkbox:checked').each(function (i) {

            FormData[i] = ($(this).val()) ;


        });


        $.ajax({
            type: 'POST',
            url: '@Url.Action("getGRNInvoice")',

            dataType: 'json',

            data: { id: FormData },


            success: function (items) {

                count = 0;

                //var obj = jQuery.parseJSON(items);
                $.each(items, function (key, value) {

                    if (count == 0) {
                        $("#cat_0").val(value.Name);
                        $("#cat_0").val = value.Name;
                        $("#Item_0").val(value.Total);
                        $("#txtQty_0").val();
                        $("#Type_0").val();
                        $("#Narration_0").val();

                    }

                    else {

                        $('#tableRoutingData').append('<tr MenuID="-1" class="trEdit" id="tr_' + count + '"><td><select id="cat_' + count + '" name="ByAccount" class="form-control Keys"/></td><td><input id="Item_' + count + '" type="text" name="DrAmount" class="form-control Keys"/></td><td>' +
                '<input id="txtQty_' + count + '" type="text" name="ChequeNo" class="form-control input-md"  /></td><td><input id="Type_' + count + '" type="text" name="ChequeDate" ' +
                 ' class="form-control input-md"/></td><td><input id="Narration_' + count + '" type="DrNarration" name="DrNarration" ' +
                 ' class="form-control input-md"/></td><td>' +
                  '<button data-val="' + count + '"' +
                 ' style="margin-top:10px;" type="button" id="btnminus_' + count + '" ' +
                 'class="minus btn btn-danger btn-sm defaults"><span class="fa fa-minus"></span></button></td></tr>');
                        $('#cat_0 option').clone().appendTo('#cat_' + count);
                        $('#Item_0 option').clone().appendTo('#Item_' + count);
                        $('#txtQty_0 option').clone().appendTo('#txtQty_' + count);
                        $('#Type_0 option').clone().appendTo('#Type_' + count);
                        $('#Narration_0 option').clone().appendTo('#Narration_' + count);
                        $("#Type_" + count).datepicker({ dateFormat: 'dd/mm/yy' });
                        //alert(value.Name);

                        $("#cat_" + count).val(value.Name);
                        $("#Item_" + count).val(value.Total);
                        $("#txtQty_" + count).val();
                        $("#Type_" + count).val();
                        $("#Narration_" + count).val();
                        //$("#Type_" + count).datepicker({ dateFormat: 'dd/mm/yy' });
                    }
                    count++;
                });

            },
            error: function (ex) {

            }
        });

        //$.post("/Finance/getGRNInvoice", '0', function (data) {


        //    });

    });


    //$('#submitgrn').on('click', function () {
    //    var sum = 0;
    //    var sum1 = 0;
    //    var count = 0;
    //    var num = 0;
    //    var $cramount ;
    //    var $dramount ;
    //    $(".item_"+num+"").each(function () {
    //        sum += +$(this).val();
    //        $('#Item_0 option').clone().appendTo('#Item_' + count);
    //    });
    //    $(".Dr_"+num+"").each(function () {
    //        sum1 += +$(this).val();
    //        $('#Dr_0 option').clone().appendTo('#Dr_' + count);
    //    });
    //    $cramount.val(sum);
    //    $dramount.val(sum1);
    //    if ($cramount.val() == $dramount.val()) {
    //        alert("Matching");
    //    } else
    //        alert("not matching");
    //});
    $('#submitgrn').on('click', function (e) {

        var credit=[];
        var debit=[];

        

            $('#@Html.IdFor(m => m.CreditAmount)').each(function(i)
            {
                credit[i]=($(this).val());
            });
            $('#@Html.IdFor(m => m.DrAmount)').each(function(i)
            {
                debit[i]=($(this).val());
            });
        
        var model = @Html.Raw(Json.Encode(Model.CreditAmount))
        var model1 = @Html.Raw(Json.Encode(Model.DrAmount))

        $.ajax({
            type: 'POST',
            url: '@Url.Action("CreditDebitValidation")',

        dataType: 'json',

        data: { id: model,model1 },


        success: function (items) {

        },
        error: function (ex) {

        }
    });
    });
</script>
<script type="text/javascript">
    $(document).ready(function () { $("#datepicker").datepicker({ dateFormat: 'dd/mm/yy' }); });
    $(document).ready(function () { $("#Type_0").datepicker({ dateFormat: 'dd/mm/yy' }); });
</script>
